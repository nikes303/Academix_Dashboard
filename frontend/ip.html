<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>College Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/minty/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  margin: 0;
  padding: 0;
}

      header {
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        background: linear-gradient(to bottom right, #1e054a, #6a2b9e);
        border-bottom: 1px solid #ddd;
        position: sticky;
        left: 0;
        right: 0;
        top: 0;
        z-index: 1020; /* Ensure header is above content */
      }
      .navbar {
        margin: 0;
        padding: 0;
      }

      .header-logo {
  height: 80px; 
  width: auto;
  position: relative; 
  top: 0; 
  left: 10px;
}

      .content {
  flex: 1;
  padding: 20px;
  background-color: #fff;
}

.footer {
  padding: 10px 20px;
  text-align: center;
  background: linear-gradient(to bottom right, #1e054a, #6a2b9e);
  color: white;
  width: 100%;
  position: fixed; /* Changed from what might be default/static */
  bottom: 0;
  left: 0;
  right: 0;
   /* Ensure it's above other elements if necessary */
}
      

      /* --- MODIFIED STYLES START --- */
      .sidebar {
        height: 100vh;
        position: fixed;
        top: 0;
        left: -250px; /* Hidden by default */
        background-color: #f8f9fa;
        width: 240px;
        padding-top: 20px;
        transition: left 0.3s ease-in-out;
        z-index: 1030; /* Make sidebar appear above everything */
      }

      .sidebar.active {
        left: 0; /* Sidebar shown */
      }
      
      /* Remove the rule that pushes the content */
      .content {
        padding: 20px;
        transition: margin-left 0.3s;
      }

      /* New overlay style */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Faded black background */
        z-index: 1025; /* Below sidebar, above content */
        display: none; /* Hidden by default */
      }
      
      #overlay.active {
        display: block; /* Show when active */
      }
      /* --- MODIFIED STYLES END --- */

      .sidebar a {
        display: block;
        color: #333;
        padding: 10px 15px;
        text-decoration: none;
      }

      .sidebar a:hover {
        background-color: #ddd;
      }

      .hamburger {
        display: block;
        width: 30px;
        height: 3px;
        background-color: #fff;
        margin: 6px auto;
        transition: 0.4s;
      }

      .hamburger.active {
        transform: rotate(90deg);
      }
    </style>
  </head>
  <body>
    <header
      class="navbar navbar-expand-lg navbar-light px-3"
      style="
        background: linear-gradient(to bottom right, #1e054a, #6a2b9e);
        height: 100px;
        border-bottom: 1px solid #ddd;
      "
    >
      <span
        style="font-size: 50px; color: white; cursor: pointer"
        onclick="toggleSidebar()"
        id="hamburger"
        >&#9776;</span
      >
      <img src="logo2.png" alt="Academix Logo" class="header-logo" />
    </header>
    
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
      <a href="ip.html">Dashboard</a>
      <a href="attendance.html">Attendance</a>
      <a href="performance.html">Performance</a>
      <a href="studentdetails.html">Student Details</a>
      <a href="teacher_todo.html">To-Do List</a>
      <a href="profile.html">Profile</a>
      <a href="index.html">Logout</a>
    </div>

    <div class="content" id="content">
      <div id="dashboard">
        <h2 style="font-family: 'Roboto Mono', monospace">
          <b>Create your personalized Dashboard.</b>
        </h2>

        <!-- In ip.html, find the dashboard summary cards and add IDs -->

<div class="row mt-4">
  <!-- Attendance Card -->
  <div class="col-md-4">
    <div class="card text-white bg-primary mb-3">
      <div class="card-header">Attendance</div>
      <div class="card-body">
        <h5 class="card-title" id="attendance-title">--% Overall</h5>
        <p class="card-text" id="attendance-text">Loading...</p>
      </div>
    </div>
  </div>
  <!-- Assignments Card -->
  <div class="col-md-4">
    <div class="card text-white bg-success mb-3">
      <div class="card-header">Assignments</div>
      <div class="card-body">
        <h5 class="card-title" id="assignments-title">-- Pending</h5>
        <p class="card-text" id="assignments-text">Loading...</p>
      </div>
    </div>
  </div>
  <!-- Upcoming Events Card -->
  <div class="col-md-4">
    <div class="card text-white bg-warning mb-3">
      <div class="card-header" id="events-header">Upcoming</div>
      <div class="card-body">
        <h5 class="card-title" id="events-title">Loading...</h5>
        <p class="card-text" id="events-text">Loading...</p>
      </div>
    </div>
  </div>
</div>

      <div id="assignments" class="mt-5">
        <h2 style="font-family: 'Roboto Mono', monospace">
          <b>Assignments.</b>
        </h2>
        <button
          class="btn btn-success mb-3"
          data-bs-toggle="modal"
          data-bs-target="#addAssignmentModal"
        >
          Add Assignment
        </button>
        <input
          type="text"
          id="searchAssignment"
          class="form-control mb-3"
          placeholder="Search assignments"
          onkeyup="searchAssignments()"
        />
        <table class="table table-hover" id="assignmentsTable">
          <thead class="table-light">
            <tr>
              <th>Assignment</th>
              <th>Deadline</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Algebra Problems</td>
              <td>2025-01-15</td>
              <td>Pending</td>
              <td>
                <button
                  class="btn btn-primary btn-sm"
                  onclick="editAssignment(this)"
                >
                  Edit
                </button>
                <button
                  class="btn btn-danger btn-sm"
                  onclick="deleteAssignment(this)"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>Physics Lab Report</td>
              <td>2025-01-20</td>
              <td>Completed</td>
              <td>
                <button
                  class="btn btn-primary btn-sm"
                  onclick="editAssignment(this)"
                >
                  Edit
                </button>
                <button
                  class="btn btn-danger btn-sm"
                  onclick="deleteAssignment(this)"
                >
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="addAssignmentModal" tabindex="-1" aria-labelledby="addAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAssignmentModalLabel">Add Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAssignmentForm">
                    <div class="mb-3">
                        <label for="assignmentName" class="form-label">Assignment Name</label>
                        <input type="text" class="form-control" id="assignmentName" required />
                    </div>
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline</label>
                        <input type="date" class="form-control" id="deadline" required />
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" required>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssignmentBtn">Save</button>
            </div>
        </div>
    </div>
</div>
<footer class="footer">
  <p>&copy; 2025 Academix</p>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
let API_URL;

// Check if the hostname is 'localhost' or '127.0.0.1' (for local development)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  // We are on the local machine, so use the local backend URL
  API_URL = 'http://localhost:3000/api';
} else {
  // We are on the live deployed site, so use the live Render URL
  API_URL = 'https://academix-backend-p6o4.onrender.com/api'; // <-- Make sure this is your actual Render URL
}
    const addAssignmentModal = new bootstrap.Modal(document.getElementById('addAssignmentModal'));
    const assignmentsTableBody = document.getElementById('assignmentsTable').querySelector('tbody');
    let currentEditId = null; // To track if the modal is for editing or adding

    // --- DATA LOADING FUNCTIONS ---

    // Fetch and display the summary data for the top cards
    async function loadDashboardSummary() {
        try {
            const response = await fetch(`${API_URL}/dashboard-summary`);
            const result = await response.json();
            if (response.ok) {
                const { attendance, assignments, events } = result.data;
                // Populate Attendance Card
                document.getElementById('attendance-title').textContent = attendance.overall;
                document.getElementById('attendance-text').textContent = attendance.text;
                // Populate Assignments Card
                document.getElementById('assignments-title').textContent = assignments.pending;
                document.getElementById('assignments-text').textContent = assignments.text;
                // Populate Events Card
                // Modify this part of the loadDashboardSummary function
// (No change needed to the variable names as the server will now send task data in the 'events' structure)

document.getElementById('events-header').textContent = "Upcoming Task"; // Change header to reflect 'Task'
document.getElementById('events-title').textContent = events.text.split('Due:')[0]; // This will show the task name
document.getElementById('events-text').textContent = events.text.includes('Due:') ? `Due: ${events.text.split('Due: ')[1]}`: "No upcoming tasks."; // This will show the due date or "No upcoming tasks."
            } else {
                 console.error('Failed to load summary, server responded with error');
            }
        } catch (error) {
            console.error('Failed to load dashboard summary:', error);
        }
    }

    // Fetch and display all assignments in the table
    async function loadAssignments() {
        try {
            const response = await fetch(`${API_URL}/assignments`);
            const result = await response.json();
            
            assignmentsTableBody.innerHTML = ''; // Clear existing rows

            if (response.ok) {
                result.data.forEach(assignment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${assignment.name}</td>
                        <td>${assignment.deadline}</td>
                        <td>${assignment.status}</td>
                        <td>
                            <button class="btn btn-primary btn-sm btn-edit" data-id="${assignment.id}">Edit</button>
                            <button class="btn btn-danger btn-sm btn-delete" data-id="${assignment.id}">Delete</button>
                        </td>
                    `;
                    assignmentsTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Failed to load assignments:', error);
            assignmentsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Could not load assignments. Is the server running?</td></tr>`;
        }
    }


    // --- EVENT LISTENERS & HANDLERS ---

    // Handle form submission from the modal (for both adding and editing)
    document.getElementById('saveAssignmentBtn').addEventListener('click', async () => {
        const assignmentData = {
            name: document.getElementById('assignmentName').value,
            deadline: document.getElementById('deadline').value,
            status: document.getElementById('status').value,
        };

        let response;
        try {
            if (currentEditId) {
                // This is an update (PUT request)
                response = await fetch(`${API_URL}/assignments/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assignmentData),
                });
            } else {
                // This is a new entry (POST request)
                response = await fetch(`${API_URL}/assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assignmentData),
                });
            }

            if (response.ok) {
                addAssignmentModal.hide(); // Close the modal
                loadAssignments(); // Refresh the table
            } else {
                const err = await response.json();
                alert(`Error: ${err.error || 'Failed to save assignment'}`);
            }
        } catch (error) {
            console.error('Failed to save assignment:', error);
            alert('A network error occurred. Please try again.');
        }
    });
    
    // Handle clicks on "Edit" and "Delete" buttons
    assignmentsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        const id = target.getAttribute('data-id');

        if (target.classList.contains('btn-edit')) {
            // Get the data from the row and populate the modal
            const row = target.closest('tr');
            const cells = row.querySelectorAll('td');
            document.getElementById('assignmentName').value = cells[0].textContent;
            document.getElementById('deadline').value = cells[1].textContent;
            document.getElementById('status').value = cells[2].textContent;
            
            currentEditId = id; // Set the ID for editing
            document.getElementById('addAssignmentModalLabel').textContent = 'Edit Assignment';
            addAssignmentModal.show();
        }

        if (target.classList.contains('btn-delete')) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                fetch(`${API_URL}/assignments/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) loadAssignments(); // Refresh list on successful deletion
                        else alert('Failed to delete assignment.');
                    });
            }
        }
    });

    // Reset modal when it's closed
    document.getElementById('addAssignmentModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('addAssignmentForm').reset();
        document.getElementById('addAssignmentModalLabel').textContent = 'Add Assignment';
        currentEditId = null; // Clear the edit ID
    });
    
    // --- UTILITY FUNCTIONS ---
    
    // Function to search/filter assignments in the table (frontend only)
    function searchAssignments() {
        const filter = document.getElementById("searchAssignment").value.toLowerCase();
        const rows = assignmentsTableBody.querySelectorAll("tr");
        rows.forEach((row) => {
            const assignmentName = row.cells[0].innerText.toLowerCase();
            row.style.display = assignmentName.includes(filter) ? "" : "none";
        });
    }

    // Function to toggle the sidebar
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.getElementById("hamburger").classList.toggle("active");
        document.getElementById("overlay").classList.toggle("active");
    }

    // --- INITIALIZATION ---
    
    // Load all data when the page is ready
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardSummary();
        loadAssignments();
    });
</script>
  </body>
</html>